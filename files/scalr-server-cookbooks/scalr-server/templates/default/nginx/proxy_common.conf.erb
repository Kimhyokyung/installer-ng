proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $remote_addr;
proxy_connect_timeout 300;
proxy_send_timeout 300;
proxy_read_timeout 300;

location ~* ^.+\.(css|js)$ {
    expires 1w;

    root <%= node[:scalr_server][:install_root] %>/embedded/scalr/app/www;

    rewrite ^/ui2/js/(.*)-[0-9]+.js /ui2/js/$1.js last;
    rewrite ^/ui2/js/(.*)-[0-9]+.css /ui2/js/$1.css last;
}

location / {
  proxy_pass http://app;
}

location /graphics/ {
  proxy_pass http://graphics/;
}

location /load_statistics/ {
  proxy_pass http://plotter;
}

location /repos/ {
  proxy_pass http://repos/;
}

location /integrations/ {
  # Allow only IPs belonging to the Scalr installation to hit this endpoint.
  allow 127.0.0.0/8;
  <% node[:scalr_server][:app][:ip_ranges].each do |range| %>
    allow <%= range %>;
  <% end %>
  deny all;
  proxy_pass http://<%= node[:scalr_server][:proxy][:integrations_upstream] %>/;
}
